<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>批量IP解析工具</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: auto;
            padding: 20px;
            background: #f9f9f9;
        }
        h1 { text-align: center; }
        textarea {
            width: 100%;
            height: 200px;
            font-size: 14px;
            padding: 10px;
        }
        button {
            padding: 10px 20px;
            margin-top: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th { background: #eee; }
        .loading { color: orange; font-weight: bold; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>批量IP解析工具 (IPv4 / IPv6)</h1>
    <p>每次最多输入 6000 个 IP 地址（每行一个），点击开始解析后可批量获取地理信息。</p>
    <textarea id="ipList" placeholder="在这里粘贴IP地址，每行一个"></textarea>
    <br>
    <button onclick="startLookup()">开始解析</button>
    <p id="status"></p>
    <table id="resultTable">
        <thead>
            <tr>
                <th>IP 地址</th>
                <th>国家</th>
                <th>地区</th>
                <th>城市</th>
                <th>ISP</th>
                <th>状态</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

<script>
async function lookupIP(ip) {
    try {
        // 使用 HTTPS & 支持 IPv6 的 API（ipapi.co）
        let response = await fetch(`https://ipapi.co/${ip}/json/`);
        if (!response.ok) throw new Error("网络错误");
        let data = await response.json();
        
        if (data.error) {
            return {ip, status: "查询失败", error: data.reason || "未知错误"};
        }

        return {
            ip,
            country: data.country_name || "",
            region: data.region || "",
            city: data.city || "",
            isp: data.org || "",
            status: "成功"
        };
    } catch (err) {
        return {ip, status: "查询失败", error: err.message};
    }
}

async function startLookup() {
    let ipList = document.getElementById("ipList").value
        .split("\n")
        .map(ip => ip.trim())
        .filter(ip => ip.length > 0);

    if (ipList.length === 0) {
        alert("请输入至少一个 IP 地址！");
        return;
    }
    if (ipList.length > 6000) {
        alert("一次最多只能解析 6000 个 IP！");
        return;
    }

    document.getElementById("status").innerHTML = `<span class="loading">正在解析 ${ipList.length} 个 IP，请稍候...</span>`;
    let tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";

    for (let i = 0; i < ipList.length; i++) {
        let result = await lookupIP(ipList[i]);
        let row = `<tr>
            <td>${result.ip}</td>
            <td>${result.country || "-"}</td>
            <td>${result.region || "-"}</td>
            <td>${result.city || "-"}</td>
            <td>${result.isp || "-"}</td>
            <td class="${result.status === "成功" ? "" : "error"}">${result.status}${result.error ? ` (${result.error})` : ""}</td>
        </tr>`;
        tbody.innerHTML += row;
    }

    document.getElementById("status").innerHTML = `<b>解析完成！</b> 共 ${ipList.length} 个 IP`;
}
</script>
</body>
</html>
